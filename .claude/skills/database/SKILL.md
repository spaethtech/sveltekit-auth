---
name: database
description: Execute database operations using psql
triggers:
  - database
  - db
  - psql
  - query
  - sql
  - schema
  - tables
  - migrations
files:
  - src/cli/index.ts
  - src/lib/types.ts
  - src/lib/adapters/drizzle.ts
---

# Database Skill

Use this skill for ALL database operations including queries, schema inspection, migrations, and data management.

## Overview

This library uses a **CLI-driven schema approach**. Schemas are generated into the user's project, not bundled with the library. The library provides:

1. **CLI** (`npx sveltekit-auth init`) - Generates schema files
2. **Adapters** - Implement the Repository pattern for database operations
3. **Multiple database support** - PostgreSQL (default), MySQL, SQLite
4. **Multiple ORM support** - Drizzle (default), Prisma

## Schema Generation

Schemas are generated by the CLI into the user's project:

```bash
# Default: PostgreSQL + Drizzle
npx sveltekit-auth init

# MySQL with Prisma
npx sveltekit-auth init -d mysql --orm prisma

# Preview without writing
npx sveltekit-auth init --dry-run
```

### Generated Files

| File | Purpose | User Modifiable? |
|------|---------|------------------|
| `users.ts` | User model - extend with custom fields | Yes |
| `auth.ts` | Accounts, sessions, verifications | No (library-managed) |

Default output: `src/lib/server/schemas/`

### Tables

| Table | Description | Schema File |
|-------|-------------|-------------|
| `users` | User accounts (extendable) | `users.ts` |
| `accounts` | Linked auth providers (OAuth, credentials) | `auth.ts` |
| `sessions` | Active sessions (database strategy) | `auth.ts` |
| `verifications` | Email verification, password reset tokens | `auth.ts` |

### Key Relationships

- `accounts.user_id` → `users.id` (cascade delete)
- `sessions.user_id` → `users.id` (cascade delete)
- `accounts` has unique constraint on `(provider, login)`

## Adapter Interface (Repository Pattern)

All database operations go through the Adapter interface. This ensures consistent behavior regardless of database or ORM choice.

```typescript
interface Adapter {
  // User methods - only 'id' is required
  createUser(data): Promise<{ id: string; [key: string]: unknown }>;
  getUser(id): Promise<{ id: string; [key: string]: unknown } | null>;
  getUserByEmail(email): Promise<{ id: string; [key: string]: unknown } | null>;
  getUserByAccount(params): Promise<{ id: string; [key: string]: unknown } | null>;
  updateUser(user): Promise<{ id: string; [key: string]: unknown }>;
  deleteUser(id): Promise<void>;

  // Account methods
  linkAccount(account): Promise<AdapterAccount>;
  unlinkAccount(params): Promise<void>;
  getAccount(params): Promise<AdapterAccount | null>;
  getAccountByLogin?(provider, login): Promise<AdapterAccount | null>;
  updateAccount?(accountId, data): Promise<AdapterAccount | null>;

  // Session methods
  createSession(session): Promise<AdapterSession>;
  getSessionAndUser(sessionToken): Promise<{ session; user } | null>;
  updateSession(session): Promise<AdapterSession | null>;
  deleteSession(sessionToken): Promise<void>;

  // Verification methods
  createVerificationToken(token): Promise<VerificationToken>;
  useVerificationToken(params): Promise<VerificationToken | null>;
}
```

See `src/lib/types.ts` for full type definitions.

## Library Development

For developing/testing this library locally, you may have a PostgreSQL instance.

### Connection Helper

```bash
source .claude/skills/database/psql.sh
```

This sources environment variables from `.env` and provides helper functions.

### Usage

```bash
# Interactive session
source .claude/skills/database/psql.sh && psql_connect

# Run a query
source .claude/skills/database/psql.sh && psql_query "SELECT * FROM users;"

# Run a query from file
source .claude/skills/database/psql.sh && psql_file /path/to/query.sql
```

### Common Operations

```bash
# List all tables
source .claude/skills/database/psql.sh && psql_query "\dt"

# Describe a table
source .claude/skills/database/psql.sh && psql_query "\d users"

# Show table schema with details
source .claude/skills/database/psql.sh && psql_query "\d+ accounts"
```

### Environment Variables

Connection details sourced from `.env`:

```
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=sveltekit_auth_dev
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
```

## Migrations

### For Library Users

Users run migrations from their project using their ORM's tooling:

**Drizzle:**
```bash
npx drizzle-kit generate  # Generate migration files
npx drizzle-kit migrate   # Apply migrations
npx drizzle-kit push      # Push schema directly (dev)
npx drizzle-kit studio    # Visual schema browser
```

**Prisma:**
```bash
npx prisma migrate dev    # Generate and apply migrations
npx prisma db push        # Push schema directly (dev)
npx prisma studio         # Visual schema browser
```

### For Library Development

When testing the library locally:

1. Create a test database
2. Generate schema with CLI: `npx tsx src/cli/index.ts init -O test/schemas`
3. Point Drizzle config at test schemas
4. Run migrations

## Supported Databases

| Database | ORM | CLI Flag |
|----------|-----|----------|
| PostgreSQL | Drizzle | `-d postgres` (default) |
| PostgreSQL | Prisma | `-d postgres --orm prisma` |
| MySQL | Drizzle | `-d mysql` |
| MySQL | Prisma | `-d mysql --orm prisma` |
| SQLite | Drizzle | `-d sqlite` |
| SQLite | Prisma | `-d sqlite --orm prisma` |

## CLI Options Reference

```bash
npx sveltekit-auth init [options]

Options:
  -d, --database <type>   postgres, mysql, sqlite (default: postgres)
      --orm <type>        drizzle, prisma (default: drizzle)
  -o, --output <dir>      Output directory (default: src/lib/server/schemas)
  -t, --tables <casing>   snake, camel, pascal (default: snake)
  -c, --columns <casing>  snake, camel, pascal (default: snake)
      --id <type>         uuid, cuid (default: uuid)
      --singular          Use singular table names
      --prefix <string>   Table name prefix (e.g., auth_)
      --soft-delete       Add deletedAt column
      --dry-run           Preview without writing
  -f, --force             Overwrite existing files
```

## Creating New Adapters

To support a new database/ORM, implement the `Adapter` interface:

```typescript
import type { Adapter } from '@sveltekit-auth/core';

export function MyAdapter(db: MyDB, schema: Schema): Adapter {
  return {
    async createUser(data) {
      // Insert into users table, return with id
    },
    async getUser(id) {
      // Select from users table by id
    },
    // ... implement all required methods
  };
}
```

Requirements:
1. Implement all methods from `Adapter` interface
2. Work with CLI-generated schema (or compatible)
3. User objects must have `id` field (other fields pass through)
4. Handle cascading deletes for accounts/sessions
